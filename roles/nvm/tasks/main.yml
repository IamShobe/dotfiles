- name: Install nvm
  shell: "curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.38.0/install.sh | bash"
  args:
    executable: /bin/bash
    chdir: "{{ dotfiles_user_home }}"
    creates: "{{ nvm_root }}/nvm.sh"

- name: Setup .profile
  lineinfile:
    path: "{{ item }}"
    line: "[ -f {{ nvm_root }}/.nvm.sh ] && source {{ nvm_root }}/nvm.sh" # This will make sure Node is on the user's PATH
    create: yes
  loop:
    - ~/.profile
    - ~/.zprofile

- name: Install .nvmrc
  template:
    src: ".nvmrc.j2"
    dest: "{{ nvm_root }}/.nvmrc"
    owner: "{{ user }}"
    mode: "0644"

- name: "Load nvm env variables in {{ zsh_setting_path }}"
  lineinfile: 
    dest: "{{ zsh_setting_path }}"
    regexp: '\.nvmrc$'
    line: "[ -f {{ nvm_root }}/.nvmrc ] && source {{ nvm_root }}/.nvmrc"
    state: present
    create: yes

- name: Install node
  shell: "source {{ nvm_root }}/nvm.sh && nvm install {{item}}"
  args:
    executable: /bin/bash
    chdir: "{{ dotfiles_user_home }}"
    creates: "{{ nvm_root }}/versions/node/v{{item}}"
  loop: "{{ node_versions }}"
